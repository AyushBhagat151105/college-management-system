generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  HOD
  TEACHER
  STUDENT
}

enum EducationYear {
  FY
  SY
  TY
  LAST
}

/**
 * ---------------- USERS ----------------
 */

model User {
  id          String  @id @default(uuid())
  clerkUserId String  @unique
  firstName    String
  lastName    String
  email       String  @unique
  profileImg  String?

  role Role

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  classId       String? // Only students use it
  class         Class?         @relation(fields: [classId], references: [id], onDelete: SetNull)
  educationYear EducationYear?

  /**
   * Relations
   */
  timetable       Timetable[]
  coursesTeaching Course[]        @relation("TeacherCourses")
  submissions     Submission[]
  results         Result[]
  attendances     Attendance[]
  notifications   Notification[]  @relation("UserNotifications")
  materials       StudyMaterial[]
  assignments     Assignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
}

/**
 * ---------------- ACADEMIC MODELS ----------------
 */

model Department {
  id             String @id @default(uuid())
  departmentName String @unique

  users            User[]
  courses          Course[]
  classes          Class[]
  academicCalendar AcademicCalendar[]
  notifications    Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AcademicCalendar {
  id        String       @id @default(uuid())
  title     String
  type      CalendarType
  startDate DateTime
  endDate   DateTime?
  details   String?

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CalendarType {
  HOLIDAY
  EVENT
  EXAM_WEEK
  SEMESTER_START
  SEMESTER_END
}

/**
 * ---------------- NOTIFICATION ----------------
 */

enum AudienceType {
  ALL
  DEPARTMENT
  CLASS
  STUDENT
  TEACHER
}

model Notification {
  id      String @id @default(uuid())
  title   String
  message String

  senderId   String
  sender     User   @relation("UserNotifications", fields: [senderId], references: [id])
  senderRole Role

  audienceType AudienceType
  departmentId String?
  classId      String?

  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  class      Class?      @relation(fields: [classId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * ---------------- COURSE & MATERIALS ----------------
 */

enum MaterialType {
  PDF
  PPT
  VIDEO
  LINK
  DOC
}

model StudyMaterial {
  id      String       @id @default(uuid())
  title   String
  fileUrl String
  type    MaterialType

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Assignment {
  id          String   @id @default(uuid())
  title       String
  description String?
  dueDate     DateTime

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  submissions Submission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Submission {
  id       String  @id @default(uuid())
  fileUrl  String
  grade    Float?
  feedback String?

  studentId String
  student   User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  submittedAt DateTime @default(now())
}

/**
 * ---------------- EXAMS & RESULTS ----------------
 */

model Exam {
  id         String   @id @default(uuid())
  title      String
  examDate   DateTime
  totalMarks Int

  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  results Result[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Result {
  id    String  @id @default(uuid())
  marks Float
  grade String?

  studentId String
  student   User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, examId])
}

/**
 * ---------------- ATTENDANCE ----------------
 */

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

model Attendance {
  id     String           @id @default(uuid())
  date   DateTime
  status AttendanceStatus

  studentId String
  student   User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation(fields: [classId], references: [id])

  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, date, courseId])
}

/**
 * ---------------- CLASS SYSTEM ----------------
 */

model Course {
  id          String  @id @default(uuid())
  courseCode  String  @unique
  courseName  String
  semester    Int
  description String?

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  teacherId String?
  teacher   User?   @relation("TeacherCourses", fields: [teacherId], references: [id], onDelete: SetNull)

  classes   Class[]     @relation("CourseToClass")
  timetable Timetable[]

  studyMaterials StudyMaterial[]
  assignments    Assignment[]
  exams          Exam[]
  attendances    Attendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseName, semester, departmentId])
}

model Class {
  id        String @id @default(uuid())
  className String

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  students  User[]
  timetable Timetable[]
  courses   Course[]    @relation("CourseToClass")

  notifications Notification[]
  attendances   Attendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([className, departmentId])
}

model Timetable {
  id        String   @id @default(uuid())
  day       String
  startTime DateTime
  endTime   DateTime

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id])

  classId String
  class   Class  @relation(fields: [classId], references: [id])

  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([day, startTime, classId, courseId])
}
